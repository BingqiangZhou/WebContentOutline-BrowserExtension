<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试重复选中问题</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
        }
        
        .section {
            margin-bottom: 50px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        
        h1, h2, h3 {
            color: #333;
            margin-top: 0;
        }
        
        .test-info {
            background: #f0f8ff;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .refresh-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        
        .refresh-btn:hover {
            background: #0056b3;
        }
        
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="test-info">
        <h1>TOC 重复选中问题测试页面</h1>
        <p><strong>测试目的：</strong>验证页面刷新时目录中不会出现多个被选中的选项</p>
        <p><strong>测试方法：</strong></p>
        <ol>
            <li>打开浏览器扩展的TOC面板</li>
            <li>点击任意目录项</li>
            <li>刷新页面（F5或Ctrl+R）</li>
            <li>检查TOC面板中是否只有一个项目被选中（高亮显示）</li>
        </ol>
        <button class="refresh-btn" onclick="location.reload()">刷新页面测试</button>
        <button class="refresh-btn" onclick="simulateContentChange()">模拟内容变化</button>
        <button class="refresh-btn" onclick="checkActiveItems()">检查选中状态</button>
    </div>

    <div id="status-container"></div>

    <div class="section">
        <h1 id="section1">第一章：介绍</h1>
        <p>这是第一章的内容。这里有足够的文本来确保页面有滚动空间，以便测试IntersectionObserver的行为。</p>
        <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>
    </div>

    <div class="section">
        <h2 id="section2">第二章：基础概念</h2>
        <p>这是第二章的内容。我们继续添加更多内容来测试目录功能。</p>
        <p>Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
        
        <h3 id="section2-1">2.1 子章节</h3>
        <p>这是一个子章节的内容。</p>
    </div>

    <div class="section">
        <h2 id="section3">第三章：高级功能</h2>
        <p>这是第三章的内容。这里我们测试更复杂的场景。</p>
        <p>Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi architecto beatae vitae dicta sunt explicabo.</p>
        
        <h3 id="section3-1">3.1 配置管理</h3>
        <p>配置管理相关内容。</p>
        
        <h3 id="section3-2">3.2 样式定制</h3>
        <p>样式定制相关内容。</p>
    </div>

    <div class="section">
        <h2 id="section4">第四章：故障排除</h2>
        <p>这是第四章的内容。最后一个主要章节。</p>
        <p>Nemo enim ipsam voluptatem quia voluptas sit aspernatur aut odit aut fugit, sed quia consequuntur magni dolores eos qui ratione voluptatem sequi nesciunt.</p>
    </div>

    <div class="section">
        <h1 id="section5">第五章：总结</h1>
        <p>这是总结章节。</p>
        <p>At vero eos et accusamus et iusto odio dignissimos ducimus qui blanditiis praesentium voluptatum deleniti atque corrupti quos dolores et quas molestias excepturi sint occaecati cupiditate non provident.</p>
    </div>

    <script>
        function showStatus(message, type = 'success') {
            const container = document.getElementById('status-container');
            const status = document.createElement('div');
            status.className = `status ${type}`;
            status.textContent = message;
            container.appendChild(status);
            
            // 5秒后自动移除
            setTimeout(() => {
                if (status.parentNode) {
                    status.parentNode.removeChild(status);
                }
            }, 5000);
        }

        function simulateContentChange() {
            // 动态添加一个新的标题
            const newSection = document.createElement('div');
            newSection.className = 'section';
            newSection.innerHTML = `
                <h2 id="dynamic-section">动态添加的章节</h2>
                <p>这是动态添加的内容，用于测试MutationObserver的行为。</p>
            `;
            document.body.appendChild(newSection);
            showStatus('已添加动态内容，TOC应该会自动更新');
        }

        function checkActiveItems() {
            // 检查页面中有多少个active的TOC项目
            const activeItems = document.querySelectorAll('.toc-item.active');
            const message = `当前有 ${activeItems.length} 个选中的目录项`;
            const type = activeItems.length <= 1 ? 'success' : 'error';
            showStatus(message, type);
            
            if (activeItems.length > 1) {
                console.warn('发现多个选中的目录项:', activeItems);
                activeItems.forEach((item, index) => {
                    console.log(`选中项 ${index + 1}:`, item.textContent);
                });
            }
        }

        // 页面加载完成后自动检查
        window.addEventListener('load', () => {
            setTimeout(() => {
                checkActiveItems();
                showStatus('页面加载完成，已自动检查选中状态');
            }, 1000);
        });

        // 监听页面可见性变化（用于检测刷新）
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                setTimeout(() => {
                    checkActiveItems();
                    showStatus('页面重新可见，已检查选中状态');
                }, 500);
            }
        });

        // 定期检查（用于调试）
        setInterval(() => {
            const activeItems = document.querySelectorAll('.toc-item.active');
            if (activeItems.length > 1) {
                console.warn(`检测到 ${activeItems.length} 个选中项，可能存在问题`);
            }
        }, 2000);
    </script>
</body>
</html>